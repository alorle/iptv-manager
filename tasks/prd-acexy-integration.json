{
  "name": "iptv-manager",
  "description": "Integrar la funcionalidad del proxy Acexy directamente en el servidor iptv-manager, eliminando la dependencia de un servicio externo. Incluye multiplexación de streams, gestión de PIDs únicos, y timeouts de producción.",
  "branchName": "ralph/acexy-integration",
  "userStories": [
    {
      "id": "US-001",
      "title": "Crear módulo de cliente Ace Stream Engine",
      "description": "Como desarrollador, quiero un módulo que se comunique con la API HTTP del Ace Stream Engine para poder obtener streams por content ID.",
      "acceptanceCriteria": [
        "Crear directorio aceproxy/ con el módulo",
        "Implementar cliente HTTP para comunicarse con el Engine",
        "Soportar endpoint /ace/getstream del Engine con parámetros id y pid",
        "Host del Engine configurable via variable de entorno ACESTREAM_ENGINE_URL (ej: http://192.168.1.100:6878)",
        "Implementar timeout de conexión configurable (default 30s)",
        "Manejar errores de conexión con el Engine apropiadamente",
        "go build passes",
        "go test ./... passes",
        "go vet ./... passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "",
      "dependsOn": [],
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-002",
      "title": "Implementar gestión de PIDs únicos",
      "description": "Como sistema, quiero asignar un PID (player ID) único a cada combinación cliente/stream para que el Engine pueda trackear las sesiones correctamente.",
      "acceptanceCriteria": [
        "Generar PIDs únicos por cada sesión cliente-stream",
        "Almacenar mapping de cliente (IP + User-Agent) a PID por stream",
        "Reutilizar PID existente si el mismo cliente reconecta al mismo stream",
        "Liberar PIDs cuando el cliente se desconecta",
        "PIDs deben ser enteros incrementales o UUIDs válidos para el Engine",
        "go build passes",
        "go test ./... passes",
        "go vet ./... passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": "",
      "dependsOn": [
        "US-001"
      ],
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-003",
      "title": "Implementar multiplexación de streams",
      "description": "Como usuario, quiero que múltiples clientes puedan ver el mismo canal simultáneamente sin que cada uno inicie una conexión separada al Engine.",
      "acceptanceCriteria": [
        "Detectar cuando múltiples clientes solicitan el mismo content ID",
        "Compartir el stream del Engine entre todos los clientes del mismo content ID",
        "Cada cliente recibe su propia copia de los datos (fan-out)",
        "El stream al Engine se cierra solo cuando el último cliente se desconecta",
        "Implementar buffer configurable para manejar diferencias de velocidad entre clientes",
        "go build passes",
        "go test ./... passes",
        "go vet ./... passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": "",
      "dependsOn": [
        "US-002"
      ],
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-004",
      "title": "Implementar timeouts de producción (PR #46)",
      "description": "Como operador, quiero que el servidor tenga timeouts apropiados para evitar que clientes colgados bloqueen recursos del servidor.",
      "acceptanceCriteria": [
        "Timeout de lectura de 5 segundos para requests de clientes",
        "Timeout de escritura de 10 segundos para responses a clientes",
        "Timeouts configurables via variables de entorno PROXY_READ_TIMEOUT y PROXY_WRITE_TIMEOUT",
        "Cerrar conexiones que excedan los timeouts limpiamente",
        "Loguear cuando se cierran conexiones por timeout",
        "go build passes",
        "go test ./... passes",
        "go vet ./... passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": "",
      "dependsOn": [
        "US-001"
      ],
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-005",
      "title": "Crear endpoint /stream",
      "description": "Como cliente, quiero acceder a streams via /stream?id=XYZ para obtener el contenido MPEG-TS del canal.",
      "acceptanceCriteria": [
        "Endpoint GET /stream acepta parámetro id (content ID de 40 caracteres hex)",
        "Validar formato del content ID (40 caracteres hexadecimales)",
        "Retornar Content-Type video/mp2t para MPEG-TS",
        "Proxy del stream desde el Engine al cliente",
        "Retornar 400 si falta el parámetro id o formato inválido",
        "Retornar 502 si no se puede conectar al Engine",
        "Soportar parámetros opcionales transcode_audio, transcode_mp3, transcode_ac3 (passthrough al Engine)",
        "go build passes",
        "go test ./... passes",
        "go vet ./... passes"
      ],
      "priority": 5,
      "passes": true,
      "notes": "",
      "dependsOn": [
        "US-003",
        "US-004"
      ],
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-006",
      "title": "Crear endpoint /ace/getstream (compatibilidad)",
      "description": "Como cliente existente, quiero poder usar el endpoint /ace/getstream?id=XYZ para mantener compatibilidad con URLs de acexy original.",
      "acceptanceCriteria": [
        "Endpoint GET /ace/getstream funciona idéntico a /stream",
        "Soporta los mismos parámetros: id, transcode_audio, transcode_mp3, transcode_ac3",
        "Internamente reutiliza la misma lógica que /stream",
        "Headers de respuesta idénticos",
        "go build passes",
        "go test ./... passes",
        "go vet ./... passes"
      ],
      "priority": 6,
      "passes": true,
      "notes": "",
      "dependsOn": [
        "US-005"
      ],
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-007",
      "title": "Actualizar rewriter para URLs internas",
      "description": "Como sistema, quiero que las playlists M3U usen URLs del propio servidor en lugar de URLs externas.",
      "acceptanceCriteria": [
        "Modificar rewriter/rewriter.go para generar URLs internas",
        "Nueva variable de entorno STREAM_BASE_URL (ej: http://mi-servidor:8080)",
        "URLs generadas formato: {STREAM_BASE_URL}/stream?id={content_id}",
        "Si STREAM_BASE_URL no está definida, usar URL relativa /stream?id={content_id}",
        "Mantener parámetro transcode_audio si estaba presente en la URL original",
        "Tests actualizados para el nuevo formato de URLs",
        "go build passes",
        "go test ./... passes",
        "go vet ./... passes"
      ],
      "priority": 7,
      "passes": false,
      "notes": "",
      "dependsOn": [
        "US-005"
      ]
    },
    {
      "id": "US-008",
      "title": "Configuración del módulo aceproxy",
      "description": "Como operador, quiero configurar el comportamiento del proxy via variables de entorno.",
      "acceptanceCriteria": [
        "ACESTREAM_ENGINE_URL - URL del Ace Stream Engine (requerido para streaming)",
        "STREAM_BASE_URL - URL base para generar URLs en playlists (opcional)",
        "PROXY_READ_TIMEOUT - Timeout de lectura (default: 5s)",
        "PROXY_WRITE_TIMEOUT - Timeout de escritura (default: 10s)",
        "PROXY_BUFFER_SIZE - Tamaño del buffer en bytes (default: 4194304 = 4MB)",
        "Documentar todas las variables en .env.example",
        "Validar configuración al inicio y mostrar errores claros",
        "go build passes",
        "go test ./... passes",
        "go vet ./... passes"
      ],
      "priority": 8,
      "passes": false,
      "notes": "",
      "dependsOn": [
        "US-004",
        "US-007"
      ]
    },
    {
      "id": "US-009",
      "title": "Tests de integración del proxy",
      "description": "Como desarrollador, quiero tests que verifiquen el funcionamiento del proxy para asegurar la calidad del código.",
      "acceptanceCriteria": [
        "Tests unitarios para gestión de PIDs",
        "Tests unitarios para lógica de multiplexación",
        "Tests de integración para endpoints /stream y /ace/getstream con mock del Engine",
        "Tests para timeouts (verificar que conexiones se cierran correctamente)",
        "Tests para el rewriter con nuevos formatos de URL",
        "Coverage mínimo del 70% para el módulo aceproxy/",
        "go build passes",
        "go test ./... passes",
        "go vet ./... passes"
      ],
      "priority": 9,
      "passes": false,
      "notes": "",
      "dependsOn": [
        "US-006",
        "US-007",
        "US-008"
      ]
    }
  ],
  "metadata": {
    "updatedAt": "2026-01-31T13:43:43.851Z"
  }
}